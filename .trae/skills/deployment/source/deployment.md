# Deployment（部署）- 部署管理 Skill

## 概述

Deployment 模块是 Squirrel 平台的核心运维功能之一，负责管理应用在服务器上的部署实例。它提供了完整的部署生命周期管理能力，包括应用的部署、启动、停止、卸载以及状态监控。

## 功能定位

- **部署管理**：将应用部署到目标服务器
- **状态控制**：管理应用的运行状态（启动/停止）
- **部署监控**：实时监控部署实例的状态
- **部署清理**：卸载不需要的部署实例
- **状态上报**：接收并更新 Agent 上报的应用状态

## 核心概念

### 部署实例（Deployment）
部署实例是应用（Application）在特定服务器（Server）上的具体运行实例，由唯一的部署 ID 标识。

### 部署 ID（Deploy ID）
每个部署实例都有一个唯一的 64 位整数 ID（deploy_id），用于在 Agent 端标识应用实例。

### 应用状态（Status）
部署实例的运行状态，支持以下状态：
- `running` - 应用正在运行
- `stopped` - 应用已停止
- `not_deployed` - 应用已创建但未部署
- `error` - 应用运行出错

### 与其他模块的关系

```
Application（应用实例）
    │
    │ [部署到服务器]
    ▼
Deployment（部署实例）
    │
    ├──> Server（目标服务器）
    │
    └──> Agent（部署执行者）
```

## 功能特性

### 1. 部署列表管理
- 查看所有部署实例
- 支持按服务器 ID 筛选部署列表
- 显示部署详情：
  - 部署 ID 和部署时间
  - 应用信息（名称、版本、类型）
  - 服务器信息（IP 地址、Agent 端口）
  - 当前运行状态

### 2. 新建部署
- 选择要部署的应用
- 选择目标服务器
- 系统自动生成唯一的部署 ID
- 调用 Agent API 执行实际部署
- 部署失败时自动回滚

### 3. 应用状态控制
- **启动应用**：将已停止的应用重新启动
- **停止应用**：优雅停止正在运行的应用
- 通过 Agent API 执行状态变更操作

### 4. 部署卸载
- 卸载不再需要的部署实例
- 调用 Agent 清理容器和资源
- 删除部署记录

### 5. 应用部署查询
- 查询指定应用在哪些服务器上有部署
- 获取服务器列表和基本信息

### 6. 状态上报（内部）
- 接收 Agent 定期上报的应用状态
- 更新部署实例的状态信息
- 确保状态数据的实时性

## 数据模型

### Deployment 结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uint | 部署记录 ID（数据库主键） |
| deploy_id | uint64 | 部署 ID（在 Agent 端标识应用） |
| application_id | uint | 关联的应用 ID |
| server_id | uint | 关联的服务器 ID |
| status | string | 部署状态 |
| created_at | time.Time | 部署时间 |

### ApplicationInfo 结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uint | 应用 ID |
| name | string | 应用名称 |
| description | string | 应用描述 |
| type | string | 应用类型 |
| version | string | 应用版本 |

### ServerInfo 结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uint | 服务器 ID |
| ip_address | string | 服务器 IP 地址 |
| agent_port | int | Agent 端口 |

## 部署流程

### 完整部署流程

```
1. 用户选择应用和服务器
   ↓
2. 系统生成唯一部署 ID
   ↓
3. 调用 Agent API 部署应用
   ↓
4. Agent 执行部署操作
   ↓
5. 部署成功？
   ├─ 是 → 创建部署记录，状态为 running
   └─ 否 → 回滚：调用 Agent 删除应用
          → 返回部署失败错误
```

### 部署回滚机制

当部署失败时，系统会自动执行以下回滚操作：
1. 调用 Agent API 删除已部署的应用
2. 不创建部署记录
3. 向用户返回详细的失败信息

## 使用场景

### 场景 1：部署新应用到服务器

1. 在部署管理页面点击"新建部署"
2. 从下拉列表选择要部署的应用（如 Nginx）
3. 选择目标服务器（如 192.168.1.100）
4. 点击"开始部署"
5. 等待部署完成
6. 查看部署状态确认成功

### 场景 2：停止正在运行的应用

1. 在部署列表中找到目标部署
2. 确认状态为 `running`
3. 点击"停止"按钮
4. 系统调用 Agent 停止应用
5. 状态更新为 `stopped`

### 场景 3：重新启动已停止的应用

1. 在部署列表中找到目标部署
2. 确认状态为 `stopped`
3. 点击"启动"按钮
4. 系统调用 Agent 启动应用
5. 状态更新为 `running`

### 场景 4：查看应用在哪些服务器上部署

1. 进入应用详情页面
2. 点击"已部署服务器"按钮
3. 系统返回所有部署该应用的服务器列表
4. 显示每台服务器的 IP 和 Agent 端口

### 场景 5：卸载部署

1. 在部署列表中找到要卸载的部署
2. 确认应用已停止（如果正在运行，先停止）
3. 点击"卸载"按钮
4. 确认卸载操作
5. 系统调用 Agent 清理应用资源
6. 删除部署记录

## 最佳实践

### 1. 部署前检查
- 确认目标服务器 Agent 状态正常
- 检查服务器资源是否充足（CPU、内存、磁盘）
- 确认端口未被占用
- 验证应用配置正确

### 2. 部署策略
- 优先在测试环境部署验证
- 使用标签管理不同环境的部署
- 记录部署配置和变更历史
- 保持应用版本与部署记录的关联

### 3. 状态管理
- 定期检查部署状态
- 及时处理 `error` 状态的部署
- 不需要的部署及时卸载，释放资源
- 监控资源使用情况

### 4. 故障处理
- 查看部署日志定位问题
- 使用 Agent 日志排查应用启动问题
- 检查网络连接和端口配置
- 必要时重新部署应用

### 5. 安全建议
- 定期更新应用版本修复安全漏洞
- 限制管理端访问 IP
- 使用强密码保护敏感配置
- 定期备份重要数据

## 常见问题

### Q1：部署失败后如何处理？
**A**：
1. 查看错误信息和日志
2. 检查服务器 Agent 状态
3. 验证应用配置是否正确
4. 修复问题后重新部署

### Q2：如何判断应用是否正常运行？
**A**：
- 查看 `status` 字段，应为 `running`
- 访问应用提供的服务端口
- 查看服务器上的容器状态（`docker ps`）
- 检查应用日志

### Q3：卸载部署会删除数据吗？
**A**：取决于应用配置：
- 如果配置了数据卷（volumes），数据会保留
- 如果未配置数据卷，容器删除时数据会丢失
- 建议卸载前备份重要数据

### Q4：能否在同一台服务器上部署同一应用的多个实例？
**A**：
- 技术上可以，但需要注意：
  - 端口不能冲突
  - 容器名称需要唯一
  - 存储卷路径不能相同
- 建议修改端口和容器名称后再部署

### Q5：部署 ID 是如何生成的？
**A**：
- 使用雪花算法（Snowflake）生成 64 位唯一 ID
- 保证全局唯一性
- 包含时间戳、机器 ID 和序列号信息

### Q6：为什么部署后状态是 `not_deployed`？
**A**：
- 这可能是部署过程中的临时状态
- 如果状态长时间不变，说明部署可能失败
- 检查 Agent 日志确认问题
- 必要时重新部署

### Q7：能否批量部署应用到多台服务器？
**A**：
- 当前版本不支持批量部署
- 需要逐台部署
- 未来版本会支持批量部署功能

## 部署状态说明

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| `running` | 应用正在正常运行 | 停止、卸载 |
| `stopped` | 应用已停止 | 启动、卸载 |
| `not_deployed` | 应用已创建但未部署 | 等待部署完成 |
| `error` | 应用运行出错 | 停止、卸载、重新部署 |

## 相关 API 文档

详细的 API 接口文档请参考：`deployment-api.md`

## 相关模块

- **Application**：应用实例管理，提供可部署的应用
- **Server**：服务器管理，管理目标服务器
- **App Store**：应用商店，提供应用模板
- **Agent**：部署执行者，在服务器上执行实际操作

## 注意事项

1. **部署前置条件**：确保目标服务器的 Agent 正常运行
2. **资源限制**：注意服务器资源限制，避免过度部署
3. **端口冲突**：同一台服务器上不能有端口冲突的部署
4. **数据备份**：卸载前备份重要数据
5. **权限管理**：确保 Agent 有足够的权限执行部署操作
6. **网络配置**：确保服务器之间的网络连通性
7. **监控告警**：建议配置监控和告警机制

## 监控和日志

### 部署日志位置
- **Server 日志**：`log/apiserver/apiserver.log`
- **Agent 日志**：`log/agent/agent.log`

### 关键监控指标
- 部署成功率
- 应用运行状态
- 资源使用情况
- 响应时间

### 日志级别
- **INFO**：正常操作日志
- **WARN**：警告信息
- **ERROR**：错误信息
- **DEBUG**：调试信息
